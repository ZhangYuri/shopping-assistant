# 实施计划

## A. 基础设施组件 (已完成)

- [x] A.1 项目基础设施搭建
  - 设置TypeScript项目结构和配置
  - 安装和配置LangChain、LangGraph核心依赖
  - 创建基础的智能体接口和抽象类
  - 设置测试框架（Jest、fast-check）
  - _需求: AR-1, AR-2_

- [x] A.2 工具集成实现
  - [x] A.2.1 数据库工具集
    - 实现所有数据库操作 DynamicTool（库存、订单、购物清单、财务、用户反馈）
    - 添加连接池和事务管理，实现工具级别的错误处理和重试
    - _需求: AR-3, FR-1.3, FR-2.1, FR-2.3_

  - [x] A.2.2 文件存储工具集
    - 实现文件上传和处理 DynamicTool，集成OCR服务和图像处理工具
    - 实现Excel文件解析工具，添加文件操作的错误处理和降级机制
    - _需求: AR-3, FR-1.2, FR-2.1_

  - [x] A.2.3 通知工具集
    - 实现多渠道通知 DynamicTool（Teams、钉钉、企业微信等）
    - 添加通知模板和用户偏好管理，实现通知发送的错误处理和重试
    - _需求: AR-3, FR-4.1_

  - [x] A.2.4 状态管理集成
    - 配置MemorySaver用于对话状态持久化，配置InMemoryStore用于通用缓存
    - 集成到智能体和LangGraph工作流中
    - _需求: AR-1, AR-3_

## B. 智能体组件

- [x] B.1 库存智能体 (已完成)
  - [x] B.1.1 核心实现
    - 实现InventoryAgent类继承自BaseAgent，使用LangChain的createReactAgent作为核心
    - 添加自然语言命令解析功能，集成数据库和文件存储DynamicTool
    - _需求: FR-1.1, FR-1.2, FR-1.3_

  - [x] B.1.2 照片处理和OCR集成
    - 添加图像上传和处理逻辑，实现OCR结果解析和数据整合
    - 添加错误处理和用户交互
    - _需求: FR-1.2_

  - [x] B.1.3 库存阈值监控
    - 添加库存水平检查逻辑，实现自动通知触发机制
    - 集成采购智能体通信
    - _需求: FR-1.3_

- [x] B.2 采购智能体 (已完成)
  - [x] B.2.1 核心实现
    - 实现ProcurementAgent类继承自BaseAgent
    - 添加订单导入和解析功能，实现多平台数据标准化
    - 集成数据库和文件存储DynamicTool
    - _需求: FR-2.1, FR-2.2_

  - [x] B.2.2 采购建议算法
    - 添加历史数据分析逻辑，实现季节性和购物活动考虑
    - 创建购物清单管理功能
    - _需求: FR-2.2, FR-2.3_

  - [x] B.2.3 用户反馈学习机制
    - 添加建议接受/拒绝处理，实现学习算法优化
    - 集成通知智能体发送建议
    - _需求: FR-2.3_

- [x] B.3 财务智能体 (待实现)
  - [x] B.3.1 创建财务智能体核心类
    - 实现FinanceAgent类继承自BaseAgent
    - 添加支出分析和分类功能，实现报告生成逻辑
    - 集成数据库和通知工具
    - _需求: FR-3.1, FR-3.2_

  - [x] B.3.2 异常消费检测
    - 添加消费模式分析算法，实现异常检测和预警机制
    - 集成预算监控功能
    - _需求: FR-3.3_

  - [x] B.3.3 定时报告生成
    - 添加月度和季度报告调度，实现自动报告发送机制
    - 集成通知智能体
    - _需求: FR-3.2_

- [ ] B.4 通知智能体 (待实现)
  - [ ] B.4.1 创建通知智能体核心类
    - 实现NotificationAgent类继承自BaseAgent
    - 添加智能通知内容生成，实现通知时机优化
    - 集成通知工具
    - _需求: FR-4.1, FR-4.2_

  - [ ] B.4.2 用户偏好学习
    - 添加通知效果分析，实现个性化推荐算法
    - 创建偏好更新机制
    - _需求: FR-4.2_

## C. 工作流和集成组件

- [x] C.1 LangGraph工作流基础 (部分完成)
  - [x] C.1.1 StateGraph工作流创建
    - 使用 LangGraph 的 StateGraph 进行智能体编排
    - 配置 MemorySaver 进行状态持久化，利用 LangGraph 内置的错误处理和重试机制
    - 定义工作流状态接口和节点函数
    - _需求: AR-1, AR-3_

  - [x] C.1.2 智能体路由实现
    - 使用 LangGraph 的条件边进行智能体路由
    - 实现自然语言意图识别和路由逻辑，利用 LangGraph 的状态管理维护上下文
    - 配置智能体节点和路由条件
    - _需求: AR-3_

- [ ] C.2 工作流完善 (待完成)
  - [x] C.2.1 完成所有智能体节点









    - 完成财务和通知智能体节点的实现
    - 修复工作流编译和执行问题，实现完整的状态管理和错误处理
    - _需求: AR-1, AR-3_

  - [ ] C.2.2 对话管理系统
    - 实现ConversationManager类，添加多轮对话上下文维护
    - 实现意图识别和实体提取，集成AgentRouter进行智能体路由
    - _需求: AR-3_

  - [ ] C.2.3 澄清机制
    - 添加模糊输入检测，实现智能澄清问题生成
    - 创建用户引导逻辑
    - _需求: AR-3_

  - [ ] C.2.4 多语言支持
    - 添加中英文输入处理，实现语言检测和切换
    - 创建多语言响应生成
    - _需求: AR-3_

## D. 系统接口和集成

- [ ] D.1 REST API接口
  - [ ] D.1.1 Express.js服务器实现
    - 实现Express.js服务器，添加智能体交互端点
    - 实现API认证和权限控制，集成ConversationManager和AgentRouter
    - _需求: NFR-3_

  - [ ] D.1.2 系统配置管理
    - 创建智能体和工具配置系统，添加智能体参数配置
    - 实现运行时配置更新
    - _需求: AR-1, AR-2_

  - [ ] D.1.3 系统监控和日志
    - 实现性能监控和指标收集，添加错误日志和事件跟踪
    - 创建健康检查端点
    - _需求: NFR-2_

## E. 测试组件

- [ ]* E.1 属性测试 (可选)
  - [ ]* E.1.1 基础设施属性测试
    - **属性 14: 安全访问控制**
    - **验证需求: 需求 AR-3**

  - [ ]* E.1.2 数据库工具属性测试
    - **属性 2: 库存数据持久化**
    - **验证需求: 需求 FR-1.3, FR-2.1**

  - [ ]* E.1.3 文件存储工具属性测试
    - **属性 4: 图像信息提取完整性**
    - **验证需求: 需求 FR-1.2, FR-2.1**

  - [ ]* E.1.4 通知工具属性测试
    - **属性 12: 通知发送可靠性**
    - **验证需求: 需求 FR-4.1, FR-4.2**

  - [ ]* E.1.5 工作流属性测试
    - **属性 13: 错误处理和恢复**
    - **验证需求: 需求 NFR-2**

  - [ ]* E.1.6 路由逻辑属性测试
    - **属性 10: 对话上下文连续性**
    - **验证需求: 需求 AR-3**

  - [ ]* E.1.7 智能体属性测试
    - **属性 1: 自然语言命令处理一致性** (库存智能体)
    - **属性 3: 阈值触发通知** (库存智能体)
    - **属性 6: 多平台数据标准化** (采购智能体)
    - **属性 7: 重复数据检测** (采购智能体)
    - **属性 5: 采购建议生成逻辑** (采购智能体)
    - **属性 8: 财务分析准确性** (财务智能体)
    - **属性 11: 多语言处理一致性** (通知智能体)
    - **属性 15: 澄清机制有效性** (对话管理)

- [ ] E.2 集成测试
  - [ ] E.2.1 集成测试套件
    - 实现完整工作流测试，添加多智能体协作测试
    - 创建错误场景测试
    - _需求: AR-1, AR-2, AR-3_

  - [ ]* E.2.2 端到端属性测试 (可选)
    - 验证所有15个正确性属性在集成环境中的表现
    - 测试工具级别的故障恢复和降级处理，验证数据一致性和完整性

  - [ ] E.2.3 性能和负载测试
    - 测试系统在高负载下的表现，验证工具调用的响应时间
    - 测试并发用户场景
    - _需求: NFR-1_

## F. 部署和文档

- [ ] F.1 部署配置
  - [ ] F.1.1 Docker配置
    - 编写Docker配置文件，创建环境变量配置模板
    - 添加数据库迁移脚本
    - _需求: NFR-3_

- [ ] F.2 文档编写
  - [ ] F.2.1 用户文档
    - 创建API文档和使用指南，编写智能体交互示例
    - 添加故障排除指南
    - _需求: NFR-5_

  - [ ] F.2.2 运维文档
    - 编写智能体和工具配置指南，创建监控和告警配置
    - 添加备份和恢复流程
    - _需求: NFR-5_

## 开发注意事项

**⚠️ 代码清理要求:**
- **每次重构或功能变更时，必须删除废弃的旧代码和相关测试**
- **避免残留逻辑导致后续开发混乱和技术债务累积**
- **在每个检查点进行代码审查，确保没有未使用的代码、导入、接口等**
- **重构时优先删除旧实现，再添加新实现，避免新旧代码共存**

## 检查点

- [ ] 检查点 1: 智能体组件完成
  - 确保B.3和B.4完成后所有测试通过
  - **代码清理检查**: 删除任何废弃的智能体代码、未使用的工具、过时的测试
  - 如有问题请询问用户

- [ ] 检查点 2: 工作流集成完成
  - 确保C.2完成后所有测试通过
  - **代码清理检查**: 删除旧的工作流实现、未使用的路由逻辑、过时的状态管理代码
  - 如有问题请询问用户

- [ ] 最终检查点: 系统完整性验证
  - 确保所有核心功能测试通过
  - **全面代码清理**: 删除所有未使用的文件、导入、接口、测试用例
  - **技术债务清理**: 确保代码库干净、一致、无冗余
  - 如有问题请询问用户
